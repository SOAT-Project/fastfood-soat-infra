name: "Echo endpoints"

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
    secrets:
      AWS_GITHUB_ACTIONS_ROLE_ARN:
        required: true
      AWS_REGION:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ inputs.environment }}-fastfood-eks --region ${{ secrets.AWS_REGION }}

      - name: Check cluster resources
        run: |
          echo "ğŸ” Verificando recursos do cluster..."
          echo ""
          echo "ğŸ“¦ Namespaces:"
          kubectl get namespaces
          echo ""
          echo "ğŸš€ Deployments no namespace fastfood:"
          kubectl get deployments -n fastfood || echo "âš ï¸  Nenhum deployment encontrado"
          echo ""
          echo "ğŸ³ Pods no namespace fastfood:"
          kubectl get pods -n fastfood || echo "âš ï¸  Nenhum pod encontrado"
          echo ""
          echo "ğŸŒ Services no namespace fastfood:"
          kubectl get svc -n fastfood || echo "âš ï¸  Nenhum service encontrado"

      - name: Debug pod failures
        if: always()
        run: |
          echo "ğŸ› Investigando falhas nos pods..."
          echo ""
          echo "â³ Aguardando pods iniciarem (30s)..."
          sleep 30
          echo ""
          echo "ğŸ” Listando pods no namespace fastfood:"
          kubectl get pods -n fastfood -o wide || true
          echo ""

          echo "ğŸ“‹ DescriÃ§Ã£o dos pods problemÃ¡ticos:"
          for pod in $(kubectl get pods -n fastfood --no-headers -o custom-columns=":metadata.name,:status.phase" | grep -v Running | awk '{print $1}'); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ $pod"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            kubectl describe pod $pod -n fastfood || true
            echo ""
          done

          echo "ğŸ§¾ Logs dos pods com falha (Ãºltimas 50 linhas):"
          for pod in $(kubectl get pods -n fastfood --no-headers -o custom-columns=":metadata.name,:status.phase" | grep -v Running | awk '{print $1}'); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Logs de $pod"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            if ! kubectl logs $pod -n fastfood --tail=50 2>/dev/null; then
              echo "âš ï¸ Nenhum log encontrado (pode ter crashado rÃ¡pido demais ou ainda estar iniciando)."
            fi
            echo ""
          done

          echo "ğŸ“… Ãšltimos eventos do namespace:"
          kubectl get events -n fastfood --sort-by=.metadata.creationTimestamp | tail -n 15 || true


      - name: Get LoadBalancer status
        id: lb
        continue-on-error: true
        run: |
          echo "ğŸ” Buscando endereÃ§o do LoadBalancer..."
          
          # Mostra o service completo
          echo "ğŸ“‹ Detalhes do Service:"
          kubectl describe svc fastfood-service -n fastfood || true
          echo ""
          
          # Tenta aguardar por atÃ© 3 minutos
          echo "â³ Aguardando LoadBalancer (timeout: 180s)..."
          kubectl wait --for=jsonpath='{.status.loadBalancer.ingress}' \
            service/fastfood-service -n fastfood --timeout=180s || echo "âš ï¸  Timeout ao aguardar LoadBalancer"
          
          # Tenta pegar hostname (AWS ELB)
          LB_HOST=$(kubectl get svc fastfood-service -n fastfood -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          
          # Se nÃ£o tiver hostname, tenta pegar IP
          if [ -z "$LB_HOST" ]; then
            LB_HOST=$(kubectl get svc fastfood-service -n fastfood -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          fi
          
          if [ -z "$LB_HOST" ]; then
            echo "âŒ LoadBalancer ainda nÃ£o foi provisionado!"
            echo "LB_HOST=pending" >> $GITHUB_ENV
            echo "LB_READY=false" >> $GITHUB_ENV
          else
            echo "LB_HOST=$LB_HOST" >> $GITHUB_ENV
            echo "LB_READY=true" >> $GITHUB_ENV
            echo "âœ… LoadBalancer encontrado: $LB_HOST"
          fi

      - name: Print Endpoints
        if: env.LB_READY == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ ENDPOINTS DO AMBIENTE: ${{ inputs.environment }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“š Swagger UI:"
          echo "   http://${{ env.LB_HOST }}/api/swagger-ui/index.html"
          echo ""
          echo "â¤ï¸  Health Check:"
          echo "   http://${{ env.LB_HOST }}/api/actuator/health"
          echo ""
          echo "ğŸŒ LoadBalancer:"
          echo "   ${{ env.LB_HOST }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: LoadBalancer not ready warning
        if: env.LB_READY != 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  LOADBALANCER NÃƒO PROVISIONADO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "PossÃ­veis causas:"
          echo "1. AWS Load Balancer Controller nÃ£o estÃ¡ instalado no cluster"
          echo "2. IAM roles/permissions incorretas"
          echo "3. Subnets nÃ£o tagueadas corretamente"
          echo "4. Security groups bloqueando"
          echo ""
          echo "Para verificar, rode localmente:"
          echo "  kubectl get svc -n fastfood"
          echo "  kubectl describe svc fastfood-service -n fastfood"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify endpoints accessibility
        if: env.LB_READY == 'true'
        run: |
          echo "ğŸ” Verificando acessibilidade dos endpoints..."
          echo "â³ Aguardando LoadBalancer ficar operacional (pode levar atÃ© 3 minutos)..."
          
          # Tenta por atÃ© 3 minutos com intervalos de 15 segundos
          for i in {1..12}; do
            sleep 15
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.LB_HOST }}/api/actuator/health 2>/dev/null || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check estÃ¡ respondendo! (tentativa $i)"
              break
            else
              echo "â³ Aguardando... (tentativa $i/12 - HTTP $HTTP_CODE)"
            fi
          done
          
          # Verifica o resultado final
          FINAL_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.LB_HOST }}/api/actuator/health 2>/dev/null || echo "000")
          if [ "$FINAL_CODE" = "200" ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… APLICAÃ‡ÃƒO ESTÃ ONLINE E RESPONDENDO!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo ""
            echo "âš ï¸  AplicaÃ§Ã£o ainda nÃ£o estÃ¡ respondendo. Aguarde alguns minutos e tente acessar os endpoints."
          fi